#!/bin/sh

# Custom River init: Hyprland-like binds with env vars, keeping vim hjkl for focus/swap

# Load environment variables
[ -f "$HOME/.config/environment.d/00-apps.conf" ] && . "$HOME/.config/environment.d/00-apps.conf"

# Make focus follow cursor
riverctl focus-follows-cursor always

# --- Launchers & Apps -----------------------------------------
riverctl map normal Super Return spawn "$TERMINAL"             # Launch terminal
riverctl map normal Super d spawn "$LAUNCHER"                  # App launcher (fuzzel)
riverctl map normal Super+Shift W spawn "$BROWSER"             # Launch browser
riverctl map normal Super E spawn "$TERMINAL -e $FILE_MANAGER" # Launch terminal with file manager (nnn)
riverctl map normal Super x spawn "xdg-open ."                 # Open current directory in GUI file manager
riverctl map normal Super F1 spawn "sh $HOME/.config/fuzzel/keys.sh" # Show keybinds menu

# --- Window Management ---------------------------------------
riverctl map normal Super q close                                # Close focused window
riverctl map normal Super+Shift q spawn "sh $HOME/.config/fuzzel/exit-menu.sh" # Exit River session (with menu)
riverctl map normal Super+Control R spawn "bash -c 'riverctl exit && exec river'" # Restart River session
riverctl map normal Super v toggle-float                         # Toggle float mode
riverctl map normal Super f toggle-fullscreen                    # Toggle fullscreen

# --- Focus & Layout (vim hjkl) -------------------------------
riverctl map normal Super j focus-view next                      # Focus next window
riverctl map normal Super k focus-view previous                  # Focus previous window
riverctl map normal Super+Shift j swap next                      # Swap with next window
riverctl map normal Super+Shift k swap previous                  # Swap with previous window
riverctl map normal Super h send-layout-cmd rivertile "main-ratio -0.05" # Shrink main area
riverctl map normal Super l send-layout-cmd rivertile "main-ratio +0.05" # Grow main area

# --- System Control -----------------------------------------
riverctl map normal Super+Shift R spawn "pkill -SIGTERM waybar && waybar &"  # Restart Waybar

# --- Tag/Workspace Management (Hyprland style) --------------
for i in $(seq 1 9); do
    tags=$((1 << (i-1)))
    riverctl map normal Super $i set-focused-tags $tags           # Switch to workspace $i
    riverctl map normal Super+Shift $i set-view-tags $tags        # Move window to workspace $i
    riverctl map normal Super+Control $i toggle-focused-tags $tags # Toggle focus on workspace $i
    riverctl map normal Super+Shift+Control $i toggle-view-tags $tags # Toggle window on workspace $i
done
all_tags=$(((1 << 32) - 1))
riverctl map normal Super 0 set-focused-tags $all_tags           # Show all workspaces
riverctl map normal Super+Shift 0 set-view-tags $all_tags        # Assign window to all workspaces

# --- Mouse ---------------------------------------------------
riverctl map-pointer normal Super BTN_LEFT move-view             # Drag window
riverctl map-pointer normal Super BTN_RIGHT resize-view          # Resize window
riverctl map-pointer normal Super BTN_MIDDLE toggle-float        # Toggle float with mouse

# --- Media & Brightness -------------------------------------
for mode in normal locked; do
    riverctl map $mode None XF86AudioRaiseVolume spawn 'pamixer -i 5'       # Volume up
    riverctl map $mode None XF86AudioLowerVolume spawn 'pamixer -d 5'       # Volume down
    riverctl map $mode None XF86AudioMute spawn 'pamixer --toggle-mute'     # Mute toggle
    riverctl map $mode None XF86AudioMedia spawn 'playerctl play-pause'     # Play/Pause
    riverctl map $mode None XF86AudioPrev spawn 'playerctl previous'        # Previous track
    riverctl map $mode None XF86AudioNext spawn 'playerctl next'            # Next track
    riverctl map $mode None XF86MonBrightnessUp spawn 'brightnessctl set +5%'  # Brightness up
    riverctl map $mode None XF86MonBrightnessDown spawn 'brightnessctl set 5%-' # Brightness down
done

# --- Screenshot --------------------------------------
riverctl map normal Super+Shift S spawn "grim -g \"\$(slurp)\" - | swappy -f -"  # Selection screenshot

# --- Passthrough Mode ----------------------------------------
riverctl declare-mode passthrough                                 # Declare passthrough mode
riverctl map normal Super F11 enter-mode passthrough              # Enable passthrough (ignore keybinds)
riverctl map passthrough Super F11 enter-mode normal              # Exit passthrough

# --- Output & Monitor Configuration -------------------------
riverctl map normal Super+Shift O spawn "wlr-randr"               # Open monitor layout tool
riverctl map normal Super+Shift K spawn "kanshi -c $HOME/.config/kanshi/config" # Apply monitor rules

# --- Input & Touchpad Settings ------------------------------
for input in $(riverctl list-inputs | grep -i touchpad); do
    riverctl input $input events enabled                          # Enable touchpad
    riverctl input $input tap enabled                             # Enable tap to click
    riverctl input $input disable-while-typing enabled            # Disable while typing
    riverctl input $input scroll-method two-finger                # Two-finger scroll
    riverctl input $input tap-button-map left-right-middle        # Standard tap map
done

# --- XDG Integration & User Dirs ----------------------------
riverctl map normal Super+Shift U spawn xdg-user-dirs-update     # Refresh user dirs
riverctl map normal Super+Shift X spawn xdg-open $HOME           # Open home in GUI file manager

# --- Rules & Autostart --------------------------------------
riverctl background-color 0x002b36                               # Background color
riverctl border-color-focused 0x93a1a1                           # Focused window border
riverctl border-color-unfocused 0x586e75                         # Unfocused window border
riverctl set-repeat 50 300                                       # Keyboard repeat rate
riverctl rule-add -app-id 'float*' float                         # Float rule for 'float*' apps
riverctl rule-add -app-id 'org.pulseaudio.pavucontrol' float     # Float pavucontrol
riverctl rule-add -app-id "$BROWSER" ssd                        # Show titlebar on browser
riverctl rule-add -app-id "$FILE_MANAGER" ssd                  # Show titlebar on file manager

# --- Auto-start applications ----------------------------------
# Prevent duplicates by killing old instances
pkill -SIGTERM polkit-gnome-authentication-agent-1
pkill -SIGTERM waybar
pkill -SIGTERM swaync
pkill -SIGTERM kanshi
pkill -SIGTERM udiskie
pkill -SIGTERM nm-applet
pkill -SIGTERM blueman-applet
pkill -SIGTERM swayidle

# Launch core services and utilities
riverctl spawn "/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 &" # Auth agent
riverctl spawn "waybar &"                         # Top bar
riverctl spawn "mako &"                        # Notification daemon
riverctl spawn "kanshi &"                          # Monitor hotplug rules
riverctl spawn "nm-applet --indicator &"           # Network manager tray
riverctl spawn "blueman-applet &"                  # Bluetooth tray
riverctl spawn "swaybg -m fill -i $HOME/.config/river/wallpapers/forest.png &" # Set wallpaper
riverctl spawn "swayidle -w timeout 300 'gtklock --style $HOME/.config/gtklock/themes/catppuccin-mocha/theme.css --daemonize' before-sleep 'gtklock --style $HOME/.config/gtklock/themes/catppuccin-mocha/theme.css --daemonize' &" # Auto lock after idle

# --- Layout ---------------------------------------------
riverctl default-layout rivertile                             # Use rivertile layout
rivertile -view-padding 3 -outer-padding 3 &                  # Layout gaps

